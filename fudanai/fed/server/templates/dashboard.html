<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Federated Task Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="p-4">
    <div class="container">
      <h1 class="mb-4">ğŸš€ Federated Task Dashboard</h1>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="tabMenu">
        <li class="nav-item">
          <a class="nav-link active" onclick="switchTab('taskTab')" href="#"
            >ä»»åŠ¡åˆ—è¡¨</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="switchTab('createTab')" href="#"
            >åˆ›å»ºä»»åŠ¡</a
          >
        </li>
      </ul>

      <!-- Task List -->
      <div id="taskTab">
        <div class="mb-3">
          <label for="taskSelect" class="form-label">é€‰æ‹©ä»»åŠ¡:</label>
          <select
            id="taskSelect"
            class="form-select"
            onchange="fetchTaskStatus()"
          ></select>
        </div>
        <div class="card">
          <div class="card-body">
            <p><strong>ä»»åŠ¡å:</strong> <span id="taskName"></span></p>
            <p><strong>çŠ¶æ€:</strong> <span id="taskStatus"></span></p>
            <p><strong>å®Œæˆè½®æ¬¡:</strong> <span id="taskEpoch"></span></p>
            <p><strong>å®¢æˆ·ç«¯çŠ¶æ€:</strong></p>
            <ul id="clientStatusList" class="list-group"></ul>
          </div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="deleteTask()">åˆ é™¤ä»»åŠ¡</button>
      </div>

      <!-- Create Task Form -->
      <div id="createTab" style="display: none">
        <form id="createForm" onsubmit="createTask(event)">
          <div class="mb-3">
            <label for="taskNameInput" class="form-label">ä»»åŠ¡å</label>
            <input
              type="text"
              class="form-control"
              id="taskNameInput"
              required
            />
          </div>
          <div class="mb-3">
            <label for="clientNum" class="form-label">å®¢æˆ·ç«¯æ•°é‡</label>
            <input type="number" class="form-control" id="clientNum" required />
          </div>
          <div class="mb-3">
            <label for="epochs" class="form-label">è®­ç»ƒè½®æ•°</label>
            <input type="number" class="form-control" id="epochs" required />
          </div>
          <div class="mb-3">
            <label for="aggregateFunc" class="form-label">èšåˆå‡½æ•°</label>
            <select class="form-select" id="aggregateFunc">
              <option value="avg">avg</option>
              <option value="median">median</option>
              <option value="prox">prox</option>
              <option value="trimmed_mean">trimmed_mean</option>
              <option value="weighted_avg">weighted_avg</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
        </form>
      </div>
    </div>

    <script>
      function switchTab(tabId) {
        document.getElementById("taskTab").style.display = "none";
        document.getElementById("createTab").style.display = "none";
        document.getElementById(tabId).style.display = "block";

        // è®¾ç½® tab æ ·å¼
        document
          .querySelectorAll(".nav-link")
          .forEach((link) => link.classList.remove("active"));
        event.target.classList.add("active");
      }

      async function deleteTask() {
        const select = document.getElementById("taskSelect");
        const taskName = select.value;
        if (!taskName) {
          alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡");
          return;
        }

        if (!confirm(`ç¡®è®¤åˆ é™¤ä»»åŠ¡ "${taskName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
          return;
        }

        const res = await fetch(`/delete_task?name=${encodeURIComponent(taskName)}`, {
          method: "DELETE",
        });

        if (res.ok) {
          alert(`ä»»åŠ¡ "${taskName}" å·²åˆ é™¤`);
          await loadTasks();      // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨ï¼Œåˆ·æ–°ä¸‹æ‹‰æ¡†
          fetchTaskStatus();      // æ¸…ç©ºæˆ–åˆ·æ–°è¯¦æƒ…æ˜¾ç¤º
        } else {
          const err = await res.json();
          alert(`åˆ é™¤å¤±è´¥ï¼š${err.error || "æœªçŸ¥é”™è¯¯"}`);
        }
      }

      async function loadTasks() {
        const res = await fetch("/list_tasks");
        const data = await res.json();
        const select = document.getElementById("taskSelect");
        select.innerHTML = "";

        data.tasks.forEach((task) => {
          const option = document.createElement("option");
          option.value = task;
          option.textContent = task;
          select.appendChild(option);
        });

        if (data.tasks.length > 0) {
          fetchTaskStatus();
        }
      }

      async function fetchTaskStatus() {
        const task = document.getElementById("taskSelect").value;
        const res = await fetch(`/${task}/status`);
        const data = await res.json();

        document.getElementById("taskName").textContent = data.task || "N/A";
        document.getElementById("taskStatus").textContent =
          data.status || "N/A";
        document.getElementById("taskEpoch").textContent =
          data.completed_epoch || 0;
        const clientStatusList = document.getElementById("clientStatusList");

        clientStatusList.innerHTML = "";
        for (const [client, status] of Object.entries(data.clients || {})) {
          const item = document.createElement("li");
          item.className = "list-group-item";
          item.textContent = `${client}: ${status}`;
          clientStatusList.appendChild(item);
        }
      }

      async function createTask(event) {
        event.preventDefault();
        const name = document.getElementById("taskNameInput").value;
        const clientNum = document.getElementById("clientNum").value;
        const epochs = document.getElementById("epochs").value;
        const aggFunc = document.getElementById("aggregateFunc").value;

        // å‘é€è¯·æ±‚
        const res = await fetch("/create_task", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name,
            client_num: parseInt(clientNum),
            epochs: parseInt(epochs),
            aggregate_func: aggFunc,
            params: {}, // é»˜è®¤ç©ºå‚æ•°
            client: "http://127.0.0.1:5001",
          }),
        });

        if (res.ok) {
          alert("ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼");
          switchTab("taskTab");
          loadTasks();
        } else {
          const err = await res.json();
          alert("é”™è¯¯ï¼š" + err.error);
        }
      }

      loadTasks();
      setInterval(fetchTaskStatus, 5000);
    </script>
  </body>
</html>
